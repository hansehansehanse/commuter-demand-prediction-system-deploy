{% extends 'admin_base_graph.html' %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <h4 class="fw-bold py-3 mb-4">
    <span class="text-muted fw-light">Forecast /</span> Custom Forecast
  </h4>

  <div class="row">
    <div class="col-12">
      <!-- <h5 class="card-header">Dataset /</span> Commuter Chart</h5> -->
      <div class="card-body" data-select2-id="47">
        <div class="row" data-select2-id="46">
          
          <div class="row">
            
            <!-- Date Picker -->
            <div class="col-md-3 mb-4">
              <label for="datePicker" class="form-label">Select Date:</label>
              <div class="input-group">
                <input type="date" id="datePicker" class="form-control form-control-lg">
                <!-- <button type="button" class="btn btn-outline-primary" onclick="setToday()">Today</button> -->
              </div>
            </div>

            <div class="col-md-3 mb-4">
              <label for="route" class="form-label">Select Route:</label>
              <div class="position-relative">
                <select id="route" class="select2 form-select form-select-lg" data-allow-clear="true" onchange="updateTimeOptions()">
                  <option value="">Select Route</option>
                  <option value="UPLB to UPD" {% if route == 'UPLB to UPD' %}selected{% endif %}>UPLB to UPD</option>
                  <option value="UPLB to Buendia" {% if route == 'UPLB to Buendia' %}selected{% endif %}>UPLB to Buendia</option>
                </select>
              </div>
            </div>
            
          
            <div class="col-md-3 mb-4">
              <label for="time" class="form-label">Select Time:</label>
              <div class="position-relative">
                <select id="time" class="select2 form-select form-select-lg" data-allow-clear="true">
                  <option value="">Select Time</option>
                  <!-- Time options will be dynamically populated via JavaScript -->
                </select>
              </div>
            </div>

            <div class="col-md-3 mb-4 d-flex align-items-end justify-content-center">
              <button id="runPredictionsBtn" class="btn btn-primary btn-lg w-100">Run Predictions</button>
              
            </div>


            
          </div>
          


        </div>

      </div>

    </div>

    <div class="col-lg-3 col-sm-6 mb-4">
      <div class="card h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0 me-2" id="avgCommutersValue">--</h5>

            <small class="text-muted" id="avgCommutersLabel">Average Commuters</small>
          </div>
          <span class="badge bg-label-success rounded-pill p-2">
            <i class="ti ti-users ti-sm"></i>
          </span>
        </div>
      </div>
    </div>  

    <div class="col-lg-3 col-sm-6 mb-4">
      <div class="card h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0 me-2" id="rfPredictionValue">--</h5>

            <small class="text-muted" id="rfPredictionLabel">Random Forest</small>
          </div>
          <span class="badge bg-label-success rounded-pill p-2">
            <i class="ti ti-users ti-sm"></i>
          </span>
        </div>
      </div>
    </div>  

    <div style="height: 25px;"></div>

    <!-- Predictions Table -->
    <div class="col-12">
      <div class="card" style="min-height: 600px;">
        <div class="card-body pb-0">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold mb-0">
              <span class="text-muted fw-light">Predictions /</span> Next 2 Weeks
            </h4>
          </div>

          <div class="table-responsive card-datatable" style="overflow-x: auto;">
            <table id="predictionsTable" class="table border-top w-100">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Route</th>
                  <th>Time</th>
                  <th>Predicted Commuters</th>
                </tr>
              </thead>
              <tbody id="predictionsTableBody">
                <!-- Filled by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>



    <div style="height: 25px;"></div>


  </row>



  



  <!-- Script for AJAX and Line Chart -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- Scipt  -->
<script>
  function setToday() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('datePicker').value = today;
  }

  let selectedRoute = '';
  let selectedTime = '';
  let selectedDate = '';

  const routeTimes = {
    "UPLB to UPD": ["5:00AM", "1:00PM", "6:00PM"],
    "UPLB to Buendia": ["5:30AM"]
  };

  document.getElementById('route').addEventListener('change', updateTimeOptions);

  function updateTimeOptions() {
    const routeSelect = document.getElementById('route');
    const timeSelect = document.getElementById('time');
    const route = routeSelect.value;

    timeSelect.innerHTML = '<option value="">Select Time</option>';
    if (route && routeTimes[route]) {
      routeTimes[route].forEach(time => {
        const opt = document.createElement("option");
        opt.value = time;
        opt.textContent = time;
        timeSelect.appendChild(opt);
      });
    }
  }

  function triggerPredictionActions() {
    selectedRoute = document.getElementById('route').value;
    selectedTime = document.getElementById('time').value;
    selectedDate = document.getElementById('datePicker').value;

    if (!selectedRoute || !selectedTime || !selectedDate) {
      alert("Please select a route, time, and date.");
      return;
    }

    console.log(`Selected Route: ${selectedRoute}`);
    console.log(`Selected Time: ${selectedTime}`);
    console.log(`Selected Date: ${selectedDate}`);

    generateAllGraphs();
  }

  async function generateAllGraphs() {
    try {
      await sendAverageCommuterAjax();
      await sendRfPredictionAjax();
      await fetchTwoWeekPredictions();
    } catch (error) {
      console.error("❌ Error in generateAllGraphs:", error);
    }
  }

  function sendAverageCommuterAjax() {
    return new Promise((resolve, reject) => {
      $.ajax({
        url: "{% url 'dataset_graph' %}",
        type: "POST",
        data: {
          graph_type: "average_from_date",
          route: selectedRoute,
          time: selectedTime,
          date: selectedDate,
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          console.log("✅ average_from_date: " + response.average);
          document.getElementById("avgCommutersValue").textContent = response.average ?? "--";
          resolve();
        },
        error: (xhr, status, err) => {
          alert("Error retrieving average commuters!");
          reject(err);
        }
      });
    });
  }

  function sendRfPredictionAjax() {
    return new Promise((resolve, reject) => {
      $.ajax({
        url: "{% url 'dataset_graph' %}",
        type: "POST",
        data: {
          graph_type: "rf_prediction",
          route: selectedRoute,
          time: selectedTime,
          date: selectedDate,
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          console.log("✅ rfPredictionValue: " + response.prediction);
          document.getElementById("rfPredictionValue").textContent = response.prediction ?? "--";
          resolve();
        },
        error: (xhr, status, err) => {
          alert("Error retrieving RF prediction!");
          reject(err);
        }
      });
    });
  }

  function fetchTwoWeekPredictions() {
    return new Promise((resolve, reject) => {
      $.ajax({
        url: "{% url 'dataset_graph' %}",
        type: "POST",
        data: {
          graph_type: "two_week_predictions",
          route: selectedRoute,
          time: selectedTime,
          date: selectedDate,
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          const tableBody = document.getElementById('predictionsTableBody');
          tableBody.innerHTML = "";

          if (response.predictions && response.predictions.length > 0) {
            response.predictions.forEach(pred => {
              const row = `
                <tr>
                  <td>${pred.date}</td>
                  <td>${pred.route}</td>
                  <td>${pred.time}</td>
                  <td>${pred.predicted_commuters}</td>
                </tr>`;
              tableBody.innerHTML += row;
            });
          } else {
            tableBody.innerHTML = "<tr><td colspan='4'>No predictions available.</td></tr>";
          }
          resolve();
        },
        error: (xhr, status, err) => {
          alert("Error fetching 2-week predictions.");
          reject(err);
        }
      });
    });
  }

  $(document).ready(function () {
    $('#runPredictionsBtn').on('click', function () {
      console.log("📌 Button clicked!");
      triggerPredictionActions();
    });

    $('#predictionsTable').DataTable({
      "order": [[0, "desc"]],
      "pageLength": 5,
      "scrollY": "400px",
      "scrollCollapse": true,
      "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
      "language": {
        "search": "_INPUT_",
        "searchPlaceholder": "Search..."
      }
    });
  });

  window.onload = function () {
    setToday();
    updateTimeOptions();
  };
</script>


<!-- Scipt  -->

</div>
{% endblock %}
